# 🎓 区块链证书存证系统 - 完整技术流程

## 一、系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              系统架构图                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌──────────────┐     ┌──────────────┐     ┌──────────────────────────┐  │
│    │   前端 Vue   │────▶│  后端 Spring │────▶│   FISCO BCOS 区块链      │  │
│    │   用户界面   │     │   Boot API   │     │   (联盟链/私有链)        │  │
│    └──────────────┘     └──────────────┘     └──────────────────────────┘  │
│           │                    │                         │                  │
│           │                    ▼                         │                  │
│           │             ┌──────────────┐                 │                  │
│           │             │    MySQL     │                 │                  │
│           │             │   业务数据   │                 │                  │
│           │             └──────────────┘                 │                  │
│           │                    │                         │                  │
│           │                    ▼                         │                  │
│           │             ┌──────────────┐                 │                  │
│           └────────────▶│    IPFS      │◀────────────────┘                  │
│                         │  文件存储    │                                    │
│                         └──────────────┘                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、核心概念解释（给客户讲的话术）

### 1. 为什么用区块链？

**传统方式的问题：**
- 证书存在数据库里，管理员可以随意修改
- 无法证明证书"从未被篡改过"
- 一旦数据库被黑，所有记录可能丢失

**区块链的优势：**
- **不可篡改**：一旦上链，任何人（包括管理员）都无法修改
- **可追溯**：每次操作都有时间戳和操作者记录
- **去中心化**：多个节点共同维护，单点故障不影响整体
- **公开透明**：任何人都可以验证证书真伪

### 2. FISCO BCOS 是什么？

FISCO BCOS 是**国产联盟链**平台，由微众银行牵头开发：
- **联盟链** = 需要许可才能加入的区块链（不像比特币那样完全公开）
- 适合企业级应用，性能高（TPS 可达数千）
- 国内很多银行、政府项目都在用
- 完全开源免费

### 3. 智能合约是什么？

智能合约 = **运行在区块链上的程序**

```
传统程序：运行在你的服务器上，你可以随时修改
智能合约：运行在区块链上，部署后代码不可更改，执行结果所有人可见
```

我们的智能合约功能：
- `storeCertificate()` - 存储证书哈希
- `verifyCertificate()` - 验证证书
- `revokeCertificate()` - 撤销证书

---

## 三、完整业务流程

### 流程1：证书颁发（存证）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         证书颁发流程                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 学生提交申请                                                             │
│     └──▶ 前端表单 ──▶ 后端API ──▶ MySQL (状态: 待审批)                       │
│                                                                             │
│  2. 辅导员审批                                                               │
│     └──▶ 审批通过 ──▶ MySQL (状态: 辅导员已审批)                             │
│                                                                             │
│  3. 学院审批                                                                 │
│     └──▶ 审批通过 ──▶ MySQL (状态: 学院已审批)                               │
│                                                                             │
│  4. 教务处审批 + 生成证书                                                    │
│     └──▶ 审批通过                                                           │
│         ├──▶ 生成证书PDF                                                    │
│         ├──▶ 计算PDF的SHA256哈希值                                          │
│         ├──▶ 上传PDF到IPFS，得到CID                                         │
│         └──▶ 调用智能合约 storeCertificate(证书编号, 哈希值)                 │
│              └──▶ 区块链返回：交易哈希 + 区块号                              │
│                                                                             │
│  5. 存储结果                                                                 │
│     └──▶ MySQL 保存：证书编号、哈希值、交易哈希、区块号、IPFS CID            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**关键点（给客户解释）：**
- 我们不把证书原文存到区块链（太大、太贵）
- 只存**哈希值**（指纹），32字节，足以证明证书未被篡改
- 原文存在 IPFS（分布式文件系统）

### 流程2：证书验证

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         证书验证流程                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  方式A：通过证书编号验证                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 用户输入证书编号                                                   │   │
│  │ 2. 后端从MySQL查询证书信息                                            │   │
│  │ 3. 调用智能合约 getCertificate(证书编号)                              │   │
│  │ 4. 对比链上哈希 vs 数据库哈希                                         │   │
│  │ 5. 返回验证结果：✅ 有效 / ❌ 无效 / ⚠️ 已撤销                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  方式B：通过上传文件验证                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 用户上传证书PDF文件                                                │   │
│  │ 2. 后端计算文件的SHA256哈希值                                         │   │
│  │ 3. 在数据库中查找匹配的证书                                           │   │
│  │ 4. 调用智能合约验证                                                   │   │
│  │ 5. 返回验证结果                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  方式C：扫描二维码验证                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 证书上印有二维码（包含证书编号）                                    │   │
│  │ 2. 用户扫码跳转到验证页面                                             │   │
│  │ 3. 自动执行方式A的验证流程                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、技术组件详解

### 1. 区块链节点部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      FISCO BCOS 节点架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   生产环境（推荐4节点）：                                                     │
│                                                                             │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐                │
│   │ 节点1   │◀──▶│ 节点2   │◀──▶│ 节点3   │◀──▶│ 节点4   │                │
│   │ 学校A   │    │ 学校B   │    │ 教育局  │    │ 第三方  │                │
│   └─────────┘    └─────────┘    └─────────┘    └─────────┘                │
│        │              │              │              │                      │
│        └──────────────┴──────────────┴──────────────┘                      │
│                           共识机制                                          │
│                    (PBFT: 3/4节点同意即生效)                                 │
│                                                                             │
│   开发/测试环境（单节点）：                                                   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │         Docker 容器                                              │      │
│   │   ┌─────────────────────────────────────────────────────────┐   │      │
│   │   │     FISCO BCOS 单节点                                   │   │      │
│   │   │     端口: 20200 (SDK连接)                               │   │      │
│   │   │     端口: 8545 (JSON-RPC)                               │   │      │
│   │   └─────────────────────────────────────────────────────────┘   │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2. SDK 连接方式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      后端连接区块链的方式                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   方式1：FISCO BCOS Java SDK（我们用的）                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  后端 ──(SSL/TLS)──▶ 节点 Channel 端口 (20200)                       │  │
│   │                                                                      │  │
│   │  需要：                                                              │  │
│   │  - ca.crt (CA证书)                                                   │  │
│   │  - sdk.crt (SDK证书)                                                 │  │
│   │  - sdk.key (SDK私钥)                                                 │  │
│   │  - fisco-config.toml (配置文件)                                      │  │
│   │                                                                      │  │
│   │  优点：性能好，功能全                                                 │  │
│   │  缺点：需要证书，配置复杂                                             │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   方式2：WeBASE-Front HTTP API（备选）                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  后端 ──(HTTP)──▶ WeBASE-Front (5002) ──▶ 节点                       │  │
│   │                                                                      │  │
│   │  优点：不需要证书，简单                                               │  │
│   │  缺点：多一层转发，性能略差                                           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3. 智能合约生命周期

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      智能合约生命周期                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. 编写合约 (Solidity)                                                    │
│      └──▶ CertificateRegistry.sol                                          │
│                                                                             │
│   2. 编译合约                                                               │
│      └──▶ 得到 ABI (接口定义) + BIN (字节码)                                │
│           - ABI: 告诉SDK怎么调用合约                                        │
│           - BIN: 合约的可执行代码                                           │
│                                                                             │
│   3. 部署合约                                                               │
│      └──▶ 发送部署交易到区块链                                              │
│           └──▶ 区块链执行BIN，返回合约地址                                  │
│                例如: 0x1234567890abcdef...                                  │
│                                                                             │
│   4. 调用合约                                                               │
│      └──▶ 通过合约地址 + ABI 调用合约方法                                   │
│           - 读取操作 (view): 不消耗gas，立即返回                            │
│           - 写入操作: 需要发交易，等待共识                                  │
│                                                                             │
│   5. 合约升级（如需要）                                                      │
│      └──▶ 部署新合约，迁移数据                                              │
│           （原合约代码不可修改）                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、数据存储策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      数据存储分层                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        区块链 (FISCO BCOS)                           │  │
│   │   存储内容：                                                         │  │
│   │   - 证书编号                                                         │  │
│   │   - 文件哈希值 (SHA256)                                              │  │
│   │   - 颁发者地址                                                       │  │
│   │   - 时间戳                                                           │  │
│   │   - 撤销状态                                                         │  │
│   │                                                                      │  │
│   │   特点：不可篡改、永久保存、所有节点同步                              │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        IPFS (分布式文件系统)                          │  │
│   │   存储内容：                                                         │  │
│   │   - 证书PDF原文件                                                    │  │
│   │   - 证书图片                                                         │  │
│   │                                                                      │  │
│   │   特点：内容寻址、去中心化、可通过CID访问                             │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        MySQL (关系数据库)                             │  │
│   │   存储内容：                                                         │  │
│   │   - 用户信息、权限                                                   │  │
│   │   - 申请记录、审批流程                                               │  │
│   │   - 证书元数据（姓名、学号、专业等）                                  │  │
│   │   - 区块链交易记录（交易哈希、区块号）                                │  │
│   │   - IPFS CID                                                         │  │
│   │                                                                      │  │
│   │   特点：查询快、支持复杂业务逻辑                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        Redis (缓存)                                   │  │
│   │   存储内容：                                                         │  │
│   │   - 用户会话 (JWT Token)                                             │  │
│   │   - 验证码                                                           │  │
│   │   - 热点数据缓存                                                     │  │
│   │                                                                      │  │
│   │   特点：高速读写、自动过期                                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、安全机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         安全机制                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. 身份认证                                                               │
│      ├── 用户登录：用户名 + 密码 + 验证码                                   │
│      ├── JWT Token：无状态认证，2小时过期                                   │
│      └── 角色权限：学生、辅导员、学院管理员、教务处、系统管理员              │
│                                                                             │
│   2. 区块链安全                                                             │
│      ├── SSL/TLS 加密通信                                                   │
│      ├── 数字签名：每笔交易都有签名                                         │
│      ├── 私钥保护：私钥不出服务器                                           │
│      └── 权限控制：只有授权地址才能存证                                     │
│                                                                             │
│   3. 数据完整性                                                             │
│      ├── SHA256 哈希：任何修改都会导致哈希变化                              │
│      ├── 区块链存证：哈希值上链后不可篡改                                   │
│      └── 双重验证：链上哈希 vs 文件实际哈希                                 │
│                                                                             │
│   4. 审计追踪                                                               │
│      ├── 操作日志：所有操作记录到数据库                                     │
│      ├── 区块链日志：交易永久记录在链上                                     │
│      └── 时间戳：精确到秒的操作时间                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、常见问题 FAQ（客户可能问的）

### Q1: 区块链存证和传统数据库有什么区别？

| 对比项 | 传统数据库 | 区块链存证 |
|--------|-----------|-----------|
| 数据修改 | 管理员可随意修改 | 任何人都无法修改 |
| 信任基础 | 信任数据库管理员 | 信任数学和密码学 |
| 故障恢复 | 依赖备份 | 多节点自动同步 |
| 法律效力 | 需要公证 | 可作为电子证据 |

### Q2: 如果区块链节点全部宕机怎么办？

- 联盟链通常部署多个节点（4个以上）
- 只要有1个节点存活，数据就不会丢失
- 节点恢复后自动同步数据

### Q3: 存证的法律效力？

- 2021年《人民法院在线诉讼规则》明确认可区块链存证
- 区块链存证已被多地法院采信
- 建议配合时间戳服务增强法律效力

### Q4: 性能如何？

- FISCO BCOS 单链 TPS 可达 10,000+
- 证书存证场景完全够用
- 读取操作（验证）是毫秒级

### Q5: 成本如何？

- FISCO BCOS 开源免费
- 主要成本：服务器（节点）+ 运维
- 单节点测试环境：1台云服务器即可

---

## 八、部署清单

### 开发环境

| 组件 | 端口 | 说明 |
|------|------|------|
| 前端 (Vue) | 3000 | Vite 开发服务器 |
| 后端 (Spring Boot) | 8080 | API 服务，context-path: /api |
| MySQL | 3306 | 业务数据库 |
| Redis | 6379 | 缓存和会话 |
| IPFS | 5001 | 文件存储 API |
| FISCO BCOS | 20200 | 区块链 SDK 连接端口 |

### 生产环境（建议）

| 组件 | 数量 | 配置建议 |
|------|------|----------|
| 前端服务器 | 1-2 | Nginx + 静态文件 |
| 后端服务器 | 2+ | 负载均衡 |
| MySQL | 1主1从 | 主从复制 |
| Redis | 1-3 | 哨兵模式 |
| IPFS | 1+ | 可选集群 |
| FISCO BCOS | 4+ | 多机构部署 |

---

## 九、快速启动命令

```bash
# 1. 启动基础服务
docker-compose up -d

# 2. 启动后端
cd backend && mvn spring-boot:run -DskipTests

# 3. 启动前端
cd frontend && npm run dev

# 4. 访问系统
# 前端: http://localhost:3000
# 后端 API: http://localhost:8080/api
```

---

## 十、联系方式

如有技术问题，请联系开发团队。